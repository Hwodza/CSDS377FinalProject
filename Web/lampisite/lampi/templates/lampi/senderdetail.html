{% extends "lampi/base.html" %}

{% block content %}
<div class="container-fluid">
    <h2 class="my-4">{{ device.name }} - Device Dashboard</h2>
    
    <!-- Current Stats Grid -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
        <!-- Memory Card -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Memory Usage</h5>
                </div>
                <div class="card-body">
                    {% if current_stats %}
                    <div class="mb-3">
                        <p class="mb-1"><strong>Free:</strong> <span id="memFree">{{ current_stats.kbmemfree }}</span> KB</p>
                        <p class="mb-1"><strong>Used:</strong> <span id="memUsed">{{ current_stats.kbmemused }}</span> KB</p>
                        <p class="mb-1"><strong>Usage:</strong> <span id="memPercent">{{ current_stats.memused_percent|floatformat:1 }}</span>%</p>
                        <div class="progress mt-2" style="height: 25px;">
                            <div id="memProgress" class="progress-bar progress-bar-striped" role="progressbar" 
                                 style="width: {{ current_stats.memused_percent }}%" 
                                 aria-valuenow="{{ current_stats.memused_percent }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ current_stats.memused_percent|floatformat:1 }}%
                            </div>
                        </div>
                    </div>
                    <div class="chart-container-sm">
                        <canvas id="memoryHistoryChart"></canvas>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0">No memory data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- CPU Card -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">CPU Status</h5>
                </div>
                <div class="card-body">
                    {% if current_stats %}
                    <div class="mb-3">
                        <p class="mb-1"><strong>Temperature:</strong> <span id="cpuTemp">{{ current_stats.cputemp|floatformat:1 }}</span>°C</p>
                        <div class="row mt-2" id="cpuCoresContainer">
                            <!-- JavaScript will populate this -->
                        </div>
                    </div>
                    <div class="chart-container-sm">
                        <canvas id="cpuHistoryChart"></canvas>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0">No CPU data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Disk Card -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Disk Utilization</h5>
                </div>
                <div class="card-body">
                    {% if chart_data.disk_stats %}
                    <div class="mb-3" id="diskStatsContainer">
                        <!-- JavaScript will populate this -->
                    </div>
                    <div class="chart-container-sm">
                        <canvas id="diskHistoryChart"></canvas>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0">No disk data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Network Card -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Network Throughput</h5>
                </div>
                <div class="card-body">
                    {% if chart_data.network_stats %}
                    <div class="mb-3" id="networkStatsContainer">
                        <!-- JavaScript will populate this -->
                    </div>
                    <div class="chart-container-sm">
                        <canvas id="networkHistoryChart"></canvas>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0">No network data available</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Memory Details Card -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header bg-purple text-white">
                    <h5 class="card-title mb-0">Memory Details</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="memoryDetailChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CPU Load Details Card -->
        <div class="col">
            <div class="card h-100">
                <div class="card-header bg-orange text-white">
                    <h5 class="card-title mb-0">CPU Load Details</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="cpuLoadChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Convert Django template variables to JS
    const deviceData = {
        current_stats: {
            kbmemfree: {{ current_stats.kbmemfree|default:0 }},
            kbmemused: {{ current_stats.kbmemused|default:0 }},
            memused_percent: {{ current_stats.memused_percent|default:0 }},
            cputemp: {{ current_stats.cputemp|default:0 }}
        },
        chart_data: {
            timestamps: {{ chart_data.timestamps|safe|default:"[]" }},
            memory_data: {
                free: {{ chart_data.memory_data.free|safe|default:"[]" }},
                used: {{ chart_data.memory_data.used|safe|default:"[]" }},
                percent: {{ chart_data.memory_data.percent|safe|default:"[]" }}
            },
            cpu_temp: {{ chart_data.cpu_temp|safe|default:"[]" }},
            cpu_loads: [
                {% for core in chart_data.cpu_loads %}
                { core: {{ core.core }}, load: {{ core.load }} }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            disk_stats: [
                {% for disk in chart_data.disk_stats %}
                { 
                    device: "{{ disk.device }}",
                    wait: {{ disk.wait }},
                    util: {{ disk.util }},
                    util_history: {{ disk.util_history|safe|default:"[]" }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            network_stats: [
                {% for net in chart_data.network_stats %}
                {
                    iface: "{{ net.iface }}",
                    rx_kb: {{ net.rx_kb }},
                    tx_kb: {{ net.tx_kb }},
                    rx_history: {{ net.rx_history|safe|default:"[]" }},
                    tx_history: {{ net.tx_history|safe|default:"[]" }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }
    };

    // Helper function to normalize values for progress bars
    function normalizeValue(value, max) {
        return Math.min((value / max) * 100, 100);
    }

    // Populate CPU Cores
    const cpuCoresContainer = document.getElementById('cpuCoresContainer');
    if (cpuCoresContainer) {
        deviceData.chart_data.cpu_loads.forEach(core => {
            const coreElement = document.createElement('div');
            coreElement.className = 'col-6 mb-2';
            coreElement.innerHTML = `
                <small>Core ${core.core}</small>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-info" role="progressbar" 
                         style="width: ${core.load * 100}%" 
                         aria-valuenow="${core.load * 100}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${core.load.toFixed(2)}
                    </div>
                </div>
            `;
            cpuCoresContainer.appendChild(coreElement);
        });
    }

    // Populate Disk Stats
    const diskStatsContainer = document.getElementById('diskStatsContainer');
    if (diskStatsContainer) {
        deviceData.chart_data.disk_stats.forEach(disk => {
            const diskElement = document.createElement('div');
            diskElement.className = 'mb-2';
            diskElement.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span>${disk.device}</span>
                    <span>${disk.util.toFixed(1)}%</span>
                </div>
                <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-warning" role="progressbar" 
                         style="width: ${disk.util}%" 
                         aria-valuenow="${disk.util}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
                <small class="text-muted">Wait: ${disk.wait.toFixed(2)}ms</small>
            `;
            diskStatsContainer.appendChild(diskElement);
        });
    }

    // Populate Network Stats
    const networkStatsContainer = document.getElementById('networkStatsContainer');
    if (networkStatsContainer) {
        deviceData.chart_data.network_stats.forEach(net => {
            const netElement = document.createElement('div');
            netElement.className = 'mb-3';
            
            // Find max value for normalization
            const maxValue = Math.max(...net.rx_history.concat(net.tx_history).filter(Number.isFinite)) || 100;
            
            netElement.innerHTML = `
                <h6>${net.iface}</h6>
                <div class="row">
                    <div class="col-6">
                        <small>RX: ${net.rx_kb.toFixed(2)} KB/s</small>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: ${normalizeValue(net.rx_kb, maxValue)}%" 
                                 aria-valuenow="${net.rx_kb}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="${maxValue}">
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <small>TX: ${net.tx_kb.toFixed(2)} KB/s</small>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: ${normalizeValue(net.tx_kb, maxValue)}%" 
                                 aria-valuenow="${net.tx_kb}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="${maxValue}">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            networkStatsContainer.appendChild(netElement);
        });
    }

    // Initialize Charts (same as before, but using deviceData instead of template variables)
    if (deviceData.chart_data.timestamps.length > 0) {
        const timeFormat = 'MMM D, HH:mm';
        const gridColor = 'rgba(0, 0, 0, 0.05)';
        const fontColor = '#666';
        
        // Memory History Chart
        new Chart(document.getElementById('memoryHistoryChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: deviceData.chart_data.timestamps,
                datasets: [
                    {
                        label: 'Used (KB)',
                        data: deviceData.chart_data.memory_data.used,
                        borderColor: 'rgba(255, 99, 132, 0.8)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 1,
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Free (KB)',
                        data: deviceData.chart_data.memory_data.free,
                        borderColor: 'rgba(54, 162, 235, 0.8)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 1,
                        tension: 0.1,
                        fill: true
                    }
                ]
            },
            options: getChartOptions('Memory Usage (KB)')
        });
        
        // CPU History Chart
        new Chart(document.getElementById('cpuHistoryChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: deviceData.chart_data.timestamps,
                datasets: [{
                    label: 'Temperature (°C)',
                    data: deviceData.chart_data.cpu_temp,
                    borderColor: 'rgba(255, 159, 64, 0.8)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    borderWidth: 1,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: getChartOptions('Temperature (°C)')
        });
        
        // Disk History Chart
        new Chart(document.getElementById('diskHistoryChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: deviceData.chart_data.timestamps,
                datasets: deviceData.chart_data.disk_stats.map((disk, index) => ({
                    label: `${disk.device} Util %`,
                    data: disk.util_history,
                    borderColor: getColorForIndex(index),
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                    borderWidth: 1,
                    tension: 0.1
                }))
            },
            options: getChartOptions('Utilization %')
        });
        
        // Network History Chart
        new Chart(document.getElementById('networkHistoryChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: deviceData.chart_data.timestamps,
                datasets: deviceData.chart_data.network_stats.flatMap(net => [
                    {
                        label: `${net.iface} RX`,
                        data: net.rx_history,
                        borderColor: 'rgba(40, 167, 69, 0.8)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 1,
                        tension: 0.1
                    },
                    {
                        label: `${net.iface} TX`,
                        data: net.tx_history,
                        borderColor: 'rgba(0, 123, 255, 0.8)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 1,
                        tension: 0.1
                    }
                ])
            },
            options: getChartOptions('Throughput (KB/s)')
        });
        
        // Memory Detail Chart
        new Chart(document.getElementById('memoryDetailChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Memory Usage'],
                datasets: [
                    {
                        label: 'Used',
                        data: [deviceData.current_stats.kbmemused],
                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                    },
                    {
                        label: 'Free',
                        data: [deviceData.current_stats.kbmemfree],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true },
                    y: { 
                        stacked: true,
                        title: { display: true, text: 'Kilobytes (KB)' }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Memory Distribution' }
                }
            }
        });
        
        // CPU Load Chart
        new Chart(document.getElementById('cpuLoadChart').getContext('2d'), {
            type: 'radar',
            data: {
                labels: deviceData.chart_data.cpu_loads.map(core => `Core ${core.core}`),
                datasets: [{
                    label: 'CPU Load',
                    data: deviceData.chart_data.cpu_loads.map(core => core.load * 100),
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    pointBackgroundColor: 'rgba(255, 159, 64, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(255, 159, 64, 1)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        angleLines: { display: true },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { 
                            callback: function(value) { return value + '%'; }
                        }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'CPU Core Utilization' }
                }
            }
        });
    }

    // Helper functions
    function getColorForIndex(index) {
        const colors = [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
        ];
        return colors[index % colors.length];
    }
    
    function getChartOptions(title) {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top',
                    labels: { color: fontColor }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { tooltipFormat: timeFormat, unit: 'hour' },
                    grid: { color: gridColor },
                    ticks: { color: fontColor }
                },
                y: {
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: title,
                        color: fontColor
                    },
                    grid: { color: gridColor },
                    ticks: { color: fontColor }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        };
    }
});
</script>

<style>
/* Same CSS as before */
:root {
    --bs-purple: #6f42c1;
    --bs-orange: #fd7e14;
}
.bg-purple { background-color: var(--bs-purple) !important; }
.bg-orange { background-color: var(--bs-orange) !important; }

.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 20px;
}
.chart-container-sm {
    position: relative;
    height: 150px;
}

.card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}
.card-header {
    border-bottom: none;
    border-radius: 10px 10px 0 0 !important;
    padding: 1rem 1.25rem;
}
.card-body {
    padding: 1.25rem;
}

.progress {
    border-radius: 10px;
    background-color: #f0f0f0;
}
.progress-bar {
    border-radius: 10px;
}

.alert {
    border-radius: 8px;
}
</style>
{% endblock %}

{% block page_event %}LAMPI List{% endblock %}
